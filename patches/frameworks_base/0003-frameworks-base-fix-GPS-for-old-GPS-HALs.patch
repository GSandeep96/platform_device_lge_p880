From aab097f9a3e40938d31fe5c09f278437f0f759af Mon Sep 17 00:00:00 2001
From: streambinder <davidepucci@hiddenhost.org>
Date: Tue, 14 Jul 2015 21:26:20 +0200
Subject: [PATCH 3/3] frameworks/base: fix GPS for old GPS HALs

---
 core/res/res/values/config.xml                                         | 3 +++
 core/res/res/values/symbols.xml                                        | 1 +
 .../core/java/com/android/server/location/GpsLocationProvider.java     | 2 ++
 3 files changed, 6 insertions(+)

diff --git a/core/res/res/values/config.xml b/core/res/res/values/config.xml
index 68df6f1..3db0863 100755
--- a/core/res/res/values/config.xml
+++ b/core/res/res/values/config.xml
@@ -1924,6 +1924,9 @@
         <item>SUPL_MODE=1</item>
     </string-array>
 
+    <!-- Enable support for legacy GPS HALs -->
+    <bool name="config_legacyGpsHAL">false</bool>
+
     <!-- If there is no preload VM number in the sim card, carriers such as
          Verizon require to load a default vm number from the configurantion.
          Define config_default_vm_number for this purpose. And there are two
diff --git a/core/res/res/values/symbols.xml b/core/res/res/values/symbols.xml
index 1055547..72797fd 100755
--- a/core/res/res/values/symbols.xml
+++ b/core/res/res/values/symbols.xml
@@ -379,6 +379,7 @@
   <java-symbol type="integer" name="config_valid_wappush_index" />
   <java-symbol type="integer" name="config_overrideHasPermanentMenuKey" />
   <java-symbol type="bool" name="config_hasPermanentDpad" />
+  <java-symbol type="bool" name="config_legacyGpsHAL" />
 
   <java-symbol type="color" name="tab_indicator_text_v4" />
 
diff --git a/services/core/java/com/android/server/location/GpsLocationProvider.java b/services/core/java/com/android/server/location/GpsLocationProvider.java
index 5ae6300..2727fd7 100644
--- a/services/core/java/com/android/server/location/GpsLocationProvider.java
+++ b/services/core/java/com/android/server/location/GpsLocationProvider.java
@@ -536,6 +536,7 @@ public class GpsLocationProvider implements LocationProviderInterface {
         Log.d(TAG, "GPS properties reloaded, size = " + properties.size());
 
         // TODO: we should get rid of C2K specific setting.
+        handleEnable();
         setSuplHostPort(properties.getProperty("SUPL_HOST"),
                         properties.getProperty("SUPL_PORT"));
         mC2KServerHost = properties.getProperty("C2K_HOST");
@@ -554,6 +555,7 @@ public class GpsLocationProvider implements LocationProviderInterface {
             properties.store(baos, null);
             native_configuration_update(baos.toString());
             Log.d(TAG, "final config = " + baos.toString());
+            handleDisable();
         } catch (IOException ex) {
             Log.w(TAG, "failed to dump properties contents");
         }
-- 
2.4.3

