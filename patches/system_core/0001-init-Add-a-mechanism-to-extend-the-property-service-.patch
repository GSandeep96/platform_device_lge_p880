From c3f2d6f5a47169a783048d4dbb89d71ac4369095 Mon Sep 17 00:00:00 2001
From: streambinder <davidepucci@hiddenhost.org>
Date: Fri, 14 Nov 2014 22:50:09 +0100
Subject: [PATCH] init: Add a mechanism to extend the property service in
 device configs Instead of every so often adding a new set of stuff here for a
 specific device, let the device includes overload the property arrays. The
 new device_perms.h header documents it

---
 init/device_perms.h     | 39 +++++++++++++++++++++++++++++++++++++++
 init/property_service.c | 10 ++++++++++
 2 files changed, 49 insertions(+)
 create mode 100644 init/device_perms.h

diff --git a/init/device_perms.h b/init/device_perms.h
new file mode 100644
index 0000000..dbd6ca4
--- /dev/null
+++ b/init/device_perms.h
@@ -0,0 +1,39 @@
+// Overload this file in your own device-specific config if you need
+// non-standard property_perms and/or control_perms structs
+//
+// To avoid conflicts...
+// if you redefine property_perms, #define PROPERTY_PERMS there
+// if you redefine control_perms, #define CONTROL_PARMS there
+//
+// A typical file will look like:
+//
+/*
+
+#define CONTROL_PERMS
+
+struct {
+    const char *service;
+    unsigned int uid;
+    unsigned int gid;
+} control_perms[] = {
+    // The default perms
+    { "dumpstate",AID_SHELL, AID_LOG },
+    { "ril-daemon",AID_RADIO, AID_RADIO },
+    // My magic device perms
+    { "rawip_vsnet1",AID_RADIO, AID_RADIO },
+    { "rawip_vsnet2",AID_RADIO, AID_RADIO },
+    { "rawip_vsnet3",AID_RADIO, AID_RADIO },
+    { "rawip_vsnet4",AID_RADIO, AID_RADIO },
+     {NULL, 0, 0 }
+};
+*/
+
+// Alternatively you can append to the existing property_perms and/or
+// control_perms structs with the following:
+/*
+#define CONTROL_PERMS_APPEND \
+    { "rawip_vsnet1",AID_RADIO, AID_RADIO }, \
+    { "rawip_vsnet2",AID_RADIO, AID_RADIO }, \
+    { "rawip_vsnet3",AID_RADIO, AID_RADIO }, \
+    { "rawip_vsnet4",AID_RADIO, AID_RADIO },
+*/
diff --git a/init/property_service.c b/init/property_service.c
index 9ac2781..2d93ac4 100644
--- a/init/property_service.c
+++ b/init/property_service.c
@@ -49,6 +49,8 @@
 #include "util.h"
 #include "log.h"
 
+#include <device_perms.h>
+
 #define PERSISTENT_PROPERTY_DIR  "/data/property"
 
 static int persistent_properties_loaded = 0;
@@ -57,6 +59,7 @@ static int property_area_inited = 0;
 static int property_set_fd = -1;
 
 /* White list of permissions for setting property services. */
+#ifndef PROPERTY_PERMS
 struct {
     const char *prefix;
     unsigned int uid;
@@ -91,16 +94,21 @@ struct {
     { "service.adb.tcp.port", AID_SHELL,    0 },
     { "persist.sys.",     AID_SYSTEM,   0 },
     { "persist.service.", AID_SYSTEM,   0 },
+    { "persist.service.", AID_RADIO,    0 },
     { "persist.security.", AID_SYSTEM,   0 },
     { "persist.service.bdroid.", AID_BLUETOOTH,   0 },
     { "selinux."         , AID_SYSTEM,   0 },
+    { "net.pdp", AID_RADIO, AID_RADIO },
     { NULL, 0, 0 }
 };
+/* Avoid extending this array. Check device_perms.h */
+#endif
 
 /*
  * White list of UID that are allowed to start/stop services.
  * Currently there are no user apps that require.
  */
+#ifndef CONTROL_PERMS
 struct {
     const char *service;
     unsigned int uid;
@@ -110,6 +118,8 @@ struct {
     { "ril-daemon",AID_RADIO, AID_RADIO },
      {NULL, 0, 0 }
 };
+/* Avoid extending this array. Check device_perms.h */
+#endif
 
 typedef struct {
     size_t size;
-- 
2.1.3
